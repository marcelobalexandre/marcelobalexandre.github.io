
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Manutenção De Schema De Banco De Dados Com Migrations Em .NET - Marcelo Alexandre</title>
  <meta name="author" content="Marcelo Alexandre">

  
  <meta name="description" content="Veja algumas dicas sobre Integração Contínua para .NET utilizando o Jenkins.">
  <meta name="keywords" content="integracao continua, jenkins, .net, ci, continuous integration, dicas">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.marcelobalexandre.com/blog/2014/10/26/manutencao-de-schema-de-banco-de-dados-com-migrations-em-net">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Marcelo Alexandre" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-54602821-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Marcelo Alexandre</a></h1>
  
    <h2>Developer</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.marcelobalexandre.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/about">About</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Manutenção De Schema De Banco De Dados Com Migrations Em .NET</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-10-26T19:55:00-02:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>26</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>7:55 pm</span></time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://www.marcelobalexandre.com">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>A manutenção de schema de banco de dados é algo importante e delicado em qualquer projeto de desenvolvimento de software. Quando o assunto é banco de dados, todos os desenvolvedores do time precisam estar na mesma página para que possamos realizar mudanças rápidas e com o mínimo de propensão a falhas possível. Com o intuito de atingirmos esses objetivos é importante que o schema do banco de dados esteja protegido pelo nosso controle de versão, e que de preferência, faça parte do processo de Integração Contínua do projeto.</p>

<p>Normalmente o processo de atualização e manutenção de schema de banco de dados é realizado de maneira manual através da criação de scripts SQL e/ou utilização de softwares que geram estes scripts a partir da comparação de dois bancos de dados. Apesar deste processo funcionar em muitos projetos existentes, ele exige muita intervenção manual, o que pode acabar atrasando o lançamento de uma nova versão do sistema e prejudicando os processos de Integração Contínua do projeto.</p>

<p>Uma maneira interessante de abordar a manutenção de schema de banco de dados é através da utilização de migrations. Neste post irei explanar um pouco sobre migrations e demonstrar uma abordagem de como utilizá-las em projetos .NET através de um ótimo framework, o <a href="https://github.com/schambers/fluentmigrator" target="_blank">FluentMigrator</a></p>

<!--more-->


<h1>O Básico Sobre Migrations</h1>

<p>As migrations surgiram como uma alternativa as alterações de banco de dados através da escrita de SQL, bem como uma maneira de evoluir o schema de banco de dados de uma forma gradativa, maneira essa muito válida quando se adota metodologias ágeis. As migrations normalmente são escritas em uma linguagem de programação mais simples para descrever as mudanças no banco de dados, o que normalmente facilita a escrita e a leitura das mesmas.</p>

<p>Esse conceito de migrations foi popularizado pela comunidade <a href="http://rubyonrails.org/" target="_blank">Ruby on Rails</a> que o aplica através das <a href="http://guides.rubyonrails.org/migrations.html" target="_blank">Active Record Migrations</a>, de onde o FluentMigrator buscou inspiração.</p>

<h2>Implementando o FluentMigrator</h2>

<p>A abordagem que irei demonstrar neste post é a que tenho utilizado e recomendado atualmente, mas ela é apenas uma das possíveis maneiras de utilização do FluentMigrator, fique a vontade para implementar da maneira que achar mais interessante para os seus projetos.</p>

<p>Para auxiliar este post eu desenvolvi um pequeno projeto de exemplo que pode ser encontrado em <a href="https://github.com/marcelobalexandre/fluentmigrator-poc" target="_blank">github.com/marcelobalexandre/fluentmigrator-poc</a>.</p>

<p>Como é possível verificar na imagem abaixo eu organizei a estrutura do projeto de exemplo da seguinte maneira:</p>

<ul>
<li><strong>Scripts</strong>: nesta pasta são mantidos os scripts SQL, nesse caso temos o de criação do banco de dados e um script de criação de tabelas antes da implementação do FluentMigrator.</li>
<li><strong>MyProject.Data.Migrations</strong>: neste projeto temos as migrations organizadas em pastas com o número da versão do projeto a que se referem e o MyProjectMigrator que é responsável por executar as migrações.</li>
<li><strong>MyProjectMigratorRunner</strong>: este projeto é um Console Application que utiliza o MyProjectMigrator para executar as migrações.</li>
</ul>


<p><img src="/images/manutencao-de-schema-de-banco-de-dados-com-migrations-em-net/solution-explorer.png"></p>

<p>Minha recomendação é criar um projeto separado que conterá as migrations e o nosso Migrator, que no projeto de exemplo chamei de MyProject.Data.Migrations. Basta criar uma Class Library e instalar o Fluent Migrator e o Fluent Migrator Runner utilizando o NuGet.</p>

<h2>Criando um Migrator Runner</h2>

<p>Para executarmos as migrations podemos utilizar o Command Line Runner (executável do próprio FluentMigrator), o MSBuild, o Rake, ou outros. Eu particularmente prefiro criar um Runner próprio para o projeto, que neste caso chamei de MyProjectMigrator.</p>

<p>Como é possível observar no código abaixo, o MyProjectMigrator é bastante simples e fácil de usar, basta invocar o método <code>Migrate</code> passando como parâmetros a ação que deseja realizar (Up ou Down), a string de conexão com o banco de dados e o MigratorEnvironment. O MigratorEnvironment é um Enumerable que criei para que você possa executar ações diferentes nas migrations dependendo do ambiente, muito útil para por exemplo, criar dados fakes (seeds) no ambiente de desenvolvimento e realizar ações exclusivas para os testes unitários. É importante observar que neste exemplo o MyProjectMigrator espera uma string de conexão para o SQL Server 2012, se o seu caso é diferente basta alterá-lo.</p>

<figure class='code'><figcaption><span>MyProjectMigrator.cs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">using</span> <span class="nn">FluentMigrator</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">FluentMigrator.Runner</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">FluentMigrator.Runner.Announcers</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">FluentMigrator.Runner.Initialization</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">FluentMigrator.Runner.Processors.SqlServer</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Reflection</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="nn">MyProject.Data.Migrations</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">enum</span> <span class="n">MigratorEnvironment</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">Development</span><span class="p">,</span>
</span><span class='line'>        <span class="n">Test</span><span class="p">,</span>
</span><span class='line'>        <span class="n">Production</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">MyProjectMigrator</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">private</span> <span class="k">class</span> <span class="nc">MigrationOptions</span> <span class="p">:</span> <span class="n">IMigrationProcessorOptions</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">public</span> <span class="kt">bool</span> <span class="n">PreviewOnly</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">public</span> <span class="kt">int</span> <span class="n">Timeout</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">public</span> <span class="kt">string</span> <span class="n">ProviderSwitches</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="k">get</span> <span class="p">{</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">NotImplementedException</span><span class="p">();</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Migrate</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">IMigrationRunner</span><span class="p">&gt;</span> <span class="n">migrationRunnerAction</span><span class="p">,</span>
</span><span class='line'>                                   <span class="kt">string</span> <span class="n">connectionString</span><span class="p">,</span>
</span><span class='line'>                                   <span class="n">MigratorEnvironment</span> <span class="n">migratorEnvironment</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">Assembly</span> <span class="n">assembly</span> <span class="p">=</span> <span class="n">Assembly</span><span class="p">.</span><span class="n">GetExecutingAssembly</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>            <span class="kt">var</span> <span class="n">textWriterAnnouncer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TextWriterAnnouncer</span><span class="p">(</span><span class="n">write</span> <span class="p">=&gt;</span> <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">write</span><span class="p">));</span>
</span><span class='line'>            <span class="kt">var</span> <span class="n">runnerContext</span> <span class="p">=</span> <span class="k">new</span> <span class="n">RunnerContext</span><span class="p">(</span><span class="n">textWriterAnnouncer</span><span class="p">);</span>
</span><span class='line'>            <span class="n">runnerContext</span><span class="p">.</span><span class="n">ApplicationContext</span> <span class="p">=</span> <span class="n">migratorEnvironment</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="kt">var</span> <span class="n">migrationOptions</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MigrationOptions</span> <span class="p">{</span> <span class="n">PreviewOnly</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span> <span class="n">Timeout</span> <span class="p">=</span> <span class="m">0</span> <span class="p">};</span>
</span><span class='line'>            <span class="kt">var</span> <span class="n">processorFactory</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SqlServer2012ProcessorFactory</span><span class="p">();</span>
</span><span class='line'>            <span class="kt">var</span> <span class="n">processor</span> <span class="p">=</span> <span class="n">processorFactory</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">connectionString</span><span class="p">,</span>
</span><span class='line'>                                                    <span class="n">textWriterAnnouncer</span><span class="p">,</span>
</span><span class='line'>                                                    <span class="n">migrationOptions</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="kt">var</span> <span class="n">migrationRunner</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MigrationRunner</span><span class="p">(</span><span class="n">assembly</span><span class="p">,</span> <span class="n">runnerContext</span><span class="p">,</span> <span class="n">processor</span><span class="p">);</span>
</span><span class='line'>            <span class="n">migrationRunnerAction</span><span class="p">(</span><span class="n">migrationRunner</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Criando as Migrations</h2>

<p>Recomendo a leitura da <a href="https://github.com/schambers/fluentmigrator/wiki/Migration" target="_blank">documentação oficial</a> sobre a criação de migrations que é bem direta e de fácil entendimento, mas basicamente para criamos uma migration é preciso criar uma nova classe que derive da classe abstrata <code>Migration</code> e implemente dois métodos, o <code>Up</code> e o <code>Down</code>. Além disso você devera adicionar o atributo Migration que aceita valores Int64, esse atributo será utilizado para identificar a migration, é baseado nesse atributo que o FluentMigrator vai saber se já rodou ou não a migration.</p>

<p>A classe abstrata <code>Migration</code> nos fornece diversos métodos para manipulação de banco de dados, o que nos permite criar tabelas, criar colunas, renomear colunas, inserir dados, executar um script SQL, dentre outras tarefas. Para conhecer mais e entender melhor esses métodos recomendo a leitura da <a href="https://github.com/schambers/fluentmigrator/wiki/Fluent-Interface" target="_blank">documentação oficial</a> sobre Fluent Interface.</p>

<p>Algo para se ter em mente na hora de criar uma migration é que não devemos agrupar muitas alterações no banco de dados em apenas uma migration, se você precisa criar duas tabelas novas por exemplo, faça isso em duas migrations  separadas e não em apenas uma. Outra boa prática é em relação aos nomes das migration, adote um padrão claro para que todo o time entenda de maneira fácil o que determinada migration irá fazer apenas olhando o nome da mesma, se sua migration irá criar uma tabela Clients por exemplo, uma boa opção seria CreateClientsTable. Outra dica é utilizar o padrão YYYYMMDDHHMM no atributo identificador da migration, dessa maneira conseguimos saber rapidamente quando foi desenvolvida e diminuímos o risco de dois desenvolvedores criarem uma migration com o mesmo identificador.</p>

<p>Criei alguns exemplos de como uso e organizo migrations no projeto de exemplo, mas lembre-se que mais importante que usar esse ou aquele padrão, é utilizar algum e fazer com que o time todo o siga.</p>

<figure class='code'><figcaption><span>01 - RunBaselineScript.cs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">using</span> <span class="nn">FluentMigrator</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="nn">MyProject.Data.Migrations._1._0._0._0</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="na">    [Migration(01)]</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">class</span> <span class="nc">RunBaselineScript</span> <span class="p">:</span> <span class="n">Migration</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Up</span><span class="p">()</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">Execute</span><span class="p">.</span><span class="n">Script</span><span class="p">(</span><span class="n">Path</span><span class="p">.</span><span class="n">Combine</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="n">CurrentDirectory</span><span class="p">,</span> <span class="s">@&quot;Scripts\02 - BaselineScript.sql&quot;</span><span class="p">));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Down</span><span class="p">()</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>201410192200 - CreateTestTable.cs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">using</span> <span class="nn">FluentMigrator</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="nn">MyProject.Data.Migrations._1._0._1._0</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="na">    [Migration(201410192200)]</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">class</span> <span class="nc">CreateTestTable</span> <span class="p">:</span> <span class="n">Migration</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Up</span><span class="p">()</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">Create</span><span class="p">.</span><span class="n">Table</span><span class="p">(</span><span class="s">&quot;Test&quot;</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">.</span><span class="n">WithColumn</span><span class="p">(</span><span class="s">&quot;Id&quot;</span><span class="p">).</span><span class="n">AsGuid</span><span class="p">().</span><span class="n">NotNullable</span><span class="p">().</span><span class="n">PrimaryKey</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Down</span><span class="p">()</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">Delete</span><span class="p">.</span><span class="n">Table</span><span class="p">(</span><span class="s">&quot;Test&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>201410192210 - AddColumnTestToTableTest.cs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">using</span> <span class="nn">FluentMigrator</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="nn">MyProject.Data.Migrations._1._0._1._0</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="na">    [Migration(201410192210)]</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">class</span> <span class="nc">AddColumnTestToTableTest</span> <span class="p">:</span> <span class="n">Migration</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Up</span><span class="p">()</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">Alter</span><span class="p">.</span><span class="n">Table</span><span class="p">(</span><span class="s">&quot;Test&quot;</span><span class="p">)</span>
</span><span class='line'>                 <span class="p">.</span><span class="n">AddColumn</span><span class="p">(</span><span class="s">&quot;Test&quot;</span><span class="p">).</span><span class="n">AsString</span><span class="p">(</span><span class="m">255</span><span class="p">).</span><span class="n">NotNullable</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Down</span><span class="p">()</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">Delete</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;Test&quot;</span><span class="p">).</span><span class="n">FromTable</span><span class="p">(</span><span class="s">&quot;Test&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>201410192215 - CreateTestTableSeedData.cs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">using</span> <span class="nn">FluentMigrator</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="nn">MyProject.Data.Migrations._1._0._1._0</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="na">    [Migration(201410192215)]</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">class</span> <span class="nc">CreateTestTableSeedData</span> <span class="p">:</span> <span class="n">Migration</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Up</span><span class="p">()</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">((</span><span class="n">MigratorEnvironment</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="n">ApplicationContext</span> <span class="p">==</span> <span class="n">MigratorEnvironment</span><span class="p">.</span><span class="n">Development</span><span class="p">)</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="n">Insert</span><span class="p">.</span><span class="n">IntoTable</span><span class="p">(</span><span class="s">&quot;Test&quot;</span><span class="p">).</span><span class="n">Row</span><span class="p">(</span><span class="k">new</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="p">(),</span> <span class="n">Test</span> <span class="p">=</span> <span class="s">&quot;Test 01&quot;</span> <span class="p">});</span>
</span><span class='line'>                <span class="n">Insert</span><span class="p">.</span><span class="n">IntoTable</span><span class="p">(</span><span class="s">&quot;Test&quot;</span><span class="p">).</span><span class="n">Row</span><span class="p">(</span><span class="k">new</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="p">(),</span> <span class="n">Test</span> <span class="p">=</span> <span class="s">&quot;Test 02&quot;</span> <span class="p">});</span>
</span><span class='line'>                <span class="n">Insert</span><span class="p">.</span><span class="n">IntoTable</span><span class="p">(</span><span class="s">&quot;Test&quot;</span><span class="p">).</span><span class="n">Row</span><span class="p">(</span><span class="k">new</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="p">(),</span> <span class="n">Test</span> <span class="p">=</span> <span class="s">&quot;Test 03&quot;</span> <span class="p">});</span>
</span><span class='line'>                <span class="n">Insert</span><span class="p">.</span><span class="n">IntoTable</span><span class="p">(</span><span class="s">&quot;Test&quot;</span><span class="p">).</span><span class="n">Row</span><span class="p">(</span><span class="k">new</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="p">(),</span> <span class="n">Test</span> <span class="p">=</span> <span class="s">&quot;Test 04&quot;</span> <span class="p">});</span>
</span><span class='line'>                <span class="n">Insert</span><span class="p">.</span><span class="n">IntoTable</span><span class="p">(</span><span class="s">&quot;Test&quot;</span><span class="p">).</span><span class="n">Row</span><span class="p">(</span><span class="k">new</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="p">(),</span> <span class="n">Test</span> <span class="p">=</span> <span class="s">&quot;Test 05&quot;</span> <span class="p">});</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Down</span><span class="p">()</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Executando as Migrations</h2>

<p>Como visto anteriormente eu criei um Migrator Runner próprio chamado MyProjectMigrator, ele pode ser utilizado para rodar as migrations nos seus projetos de teste, em uma Console Application (como é o caso do projeto de exemplo) ou em um aplicativo com uma interface gráfica amigável. Como é possível observar no projeto de exemplo a utilização do MyProjectMigrator é bastante simples e pode ser customizada, mas se preferir outras maneiras de rodar as migrations, dê uma conferida na d<a href="https://github.com/schambers/fluentmigrator/wiki/Migration-Runners" target="_blank">documentação oficial</a> sobre Migration Runners.</p>

<p>Após a execução das migrations, como pode ser verificado nas imagens abaixo, o FluentMigrator irá criar uma tabela <code>VersionInfo</code> no seu banco de dados onde salvará a identificação das migrations que foram executadas, com a data e hora da execução das mesmas bem como sua descrição, que nada mais é do que o nome das classes.</p>

<p><img src="/images/manutencao-de-schema-de-banco-de-dados-com-migrations-em-net/database.png"></p>

<p><img src="/images/manutencao-de-schema-de-banco-de-dados-com-migrations-em-net/version-info.png"></p>

<h1>Conclusão</h1>

<p>O que gosto nesta abordagem é a facilidade que qualquer desenvolvedor têm de realizar uma alteração no banco de dados, bem como compreender o que determinada migration, criada por outro desenvolvedor, irá realizar. A maneira que o FluentMigrator controla quais migrations foram executadas pelo número identificador, traz mais segurança na hora de atualizar o banco de dados de um cliente, e tudo isso permite que o processo de Integração Contínua funcione de maneira adequada. Ao invés de termos a necessidade de alguém executar algum software que gere um script de alteração de banco de dados, de maneira manual, a cada nova versão do sistema, basta fazer com que um Gerenciador ou Atualizar de Banco de Dados do projeto seja compilado com a versão correta do projeto que contêm as migrations.</p>

<p>Apesar de minha preferência pela utilização de migrations, é importante que você estude e adote a estratégia mais importante para o seu projeto. Se sua opção for utilizar migrations, não fique preso na maneira que eu utilizo, adapte para que funcione melhor para o seu projeto. Enfim, o que gostaria de passar neste post era isso, por favor deixe seu comentário com críticas, dúvidas ou sugestões.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Marcelo Alexandre</span></span>

      




<time class='entry-date' datetime='2014-10-26T19:55:00-02:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>26</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>7:55 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/dot-net/'>.net</a>, <a class='category' href='/blog/categories/ci/'>ci</a>, <a class='category' href='/blog/categories/dicas/'>dicas</a>, <a class='category' href='/blog/categories/integracao-continua/'>integracao continua</a>, <a class='category' href='/blog/categories/jenkins/'>jenkins</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://www.marcelobalexandre.com/blog/2014/10/26/manutencao-de-schema-de-banco-de-dados-com-migrations-em-net/" data-via="" data-counturl="http://www.marcelobalexandre.com/blog/2014/10/26/manutencao-de-schema-de-banco-de-dados-com-migrations-em-net/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/09/07/dicas-sobre-integracao-continua-com-net-e-jenkins/" title="Previous Post: Dicas sobre Integração Contínua com .NET e Jenkins">&laquo; Dicas sobre Integração Contínua com .NET e Jenkins</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/10/26/manutencao-de-schema-de-banco-de-dados-com-migrations-em-net/">Manutenção De Schema De Banco De Dados Com Migrations Em .NET</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/07/dicas-sobre-integracao-continua-com-net-e-jenkins/">Dicas Sobre Integração Contínua Com .NET E Jenkins</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/16/como-um-tomate-pode-melhorar-sua-produtividade/">Como Um Tomate Pode Melhorar Sua Produtividade?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/01/but-why-what-do-i-have-to-say/">But, Why? What Do I Have to Say?</a>
      </li>
    
  </ul>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/107368313309412247363?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Marcelo Alexandre -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'marcelobalexandre';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.marcelobalexandre.com/blog/2014/10/26/manutencao-de-schema-de-banco-de-dados-com-migrations-em-net/';
        var disqus_url = 'http://www.marcelobalexandre.com/blog/2014/10/26/manutencao-de-schema-de-banco-de-dados-com-migrations-em-net/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
